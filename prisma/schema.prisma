// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x", "linux-musl", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ENUMS
enum Role {
  ADMIN
  ORGANIZER
  STAFF
}

enum OrderStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentProvider {
  MOCK      // Para pruebas
  STRIPE    // Futuro
  PAYPAL    // Futuro
}

enum Category {
  RUNNING
  CICLISMO
  TRIATLON
  NATACION
  OTRO
}

// MODELOS

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String?
  role          Role      @default(ORGANIZER)
  
  // Configuraci贸n de Pagos del Organizador (SaaS)
  stripeConnectId String? // ID de cuenta conectada de Stripe
  paypalEmail     String? // Email de PayPal business
  
  events        Event[]
  createdAt     DateTime  @default(now())
}

model Event {
  id            String    @id @default(cuid())
  slug          String    @unique @default(cuid()) // Default temporal para evitar errores
  title         String
  date          DateTime
  location      String
  
  // Mejoras MVP Pro
  category      Category  @default(OTRO)
  shortDesc     String?   // Descripci贸n corta para las tarjetas
  longDesc      String?   @db.Text // Descripci贸n larga y detallada
  bannerUrl     String?   // URL de la imagen (Externa o local)
  
  organizerId   String?   // Opcional por ahora para facilitar pruebas sin login
  organizer     User?     @relation(fields: [organizerId], references: [id])
  
  ticketTypes   TicketType[]
  products      Product[] 
  registrations Registration[]
  
  isPublished   Boolean   @default(true)
  createdAt     DateTime  @default(now())
}

model TicketType {
  id            String    @id @default(cuid())
  name          String
  description   String?
  price         Decimal   @db.Decimal(10, 2)
  quantity      Int
  sold          Int       @default(0) // Control de cupos vendidos
  
  eventId       String
  event         Event     @relation(fields: [eventId], references: [id])
  registrations Registration[]
}

model Product {
  id            String    @id @default(cuid())
  name          String
  price         Decimal   @db.Decimal(10, 2)
  imageUrl      String?
  eventId       String
  event         Event     @relation(fields: [eventId], references: [id])
  orderItems    OrderItem[]
}

model Registration {
  id            String     @id @default(cuid())
  
  // Relaciones
  ticketId      String
  ticket        TicketType @relation(fields: [ticketId], references: [id])
  eventId       String
  event         Event      @relation(fields: [eventId], references: [id])
  
  // Datos del Atleta
  athleteName   String
  athleteEmail  String
  athleteData   Json?      // Datos flexibles: { talla: "M", sangre: "O+" }
  
  // QR Check-in System
  qrCode        String     @unique @default(uuid())
  checkedIn     Boolean    @default(false)
  checkInTime   DateTime?

  orders        Order[]
  createdAt     DateTime   @default(now())
}

model Order {
  id              String      @id @default(cuid())
  totalAmount     Decimal     @db.Decimal(10, 2)
  status          OrderStatus @default(PENDING)
  
  // Datos de la transacci贸n
  paymentProvider PaymentProvider @default(MOCK)
  transactionId   String?   // ID externo (Stripe/PayPal)
  
  registrationId  String
  registration    Registration @relation(fields: [registrationId], references: [id])
  items           OrderItem[]
  
  createdAt       DateTime    @default(now())
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
}